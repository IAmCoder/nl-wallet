# taken from previous GitHub repository
BUILD_OFFSET = 861

# opt out of analytics
opt_out_usage

# do not generate README.md
skip_docs

private_lane :get_local_version_and_build do
  Dir.chdir("..") do
    YAML.load_file("pubspec.yaml")["version"].split("+", 2)
  end
end

private_lane :ci_get_build do
  pipeline_id = ENV["CI_PIPELINE_IID"]
  UI.user_error!("No CI_PIPELINE_IID environment variable set") unless pipeline_id

  pipeline_id.to_i + BUILD_OFFSET
end

private_lane :ci_get_app_identifier_and_version do
  app_identifier = CredentialsManager::AppfileConfig.try_fetch_value(:app_identifier)
  UI.user_error!("No app_identifier set") unless app_identifier

  ref_name = ENV["CI_COMMIT_REF_NAME"]
  UI.user_error!("No CI_COMMIT_REF_NAME environment variable set") unless ref_name

  release, version = ref_name.match(/([^\/]+)(?:\/(\d+\.\d+\.\d+))?$/)&.captures

  app_identifier = "#{app_identifier}.#{release}" unless release == "release"

  [app_identifier, version]
end

lane :disable_flutter_analytics do 
  sh("dart", "--disable-analytics")
  sh("flutter", "config", "--no-analytics")
end

platform :android do
  desc "Build Android app from GitLab CI"
  lane :ci_build do
    build = ci_get_build
    app_identifier, version = ci_get_app_identifier_and_version

    build(package_name: app_identifier, build: build, version: version)
  end 

  desc "Build Android app without signing"
  lane :build do |options|
    package_name = options[:package_name] || CredentialsManager::AppfileConfig.try_fetch_value(:app_identifier)
    UI.user_error!("No app_identifier or package_name option set") unless package_name

    local_version, local_build = get_local_version_and_build
    build = options[:build] || local_build
    version = options[:version] || local_version

    Dir.chdir("..") do
      sh("flutter", "pub", "get")
      # TODO: implement changing the app name as well, once the following bug is fixed:
      #       https://github.com/onatcipli/rename/issues/43
      sh("flutter", "pub", "run", "rename", "--target", "android", "--bundleId", package_name)
      sh("flutter", "build", "apk", "--build-number", build.to_s, "--build-name", version.to_s)
      sh("mv", "build/app/outputs/apk/release/app-release.apk", "build/app/outputs/apk/release/#{package_name}-#{version}.apk")
    end
  end
end

platform :ios do
  desc "Build iOS app from GitLab CI"
  lane :ci_build do
    build = ci_get_build
    app_identifier, version = ci_get_app_identifier_and_version

    build(bundle_id: app_identifier, build: build, version: version)
  end

  desc "Build iOS app without signing"
  lane :build do |options|
    bundle_id = options[:bundle_id] || CredentialsManager::AppfileConfig.try_fetch_value(:app_identifier)
    UI.user_error!("No app_identifier or bundle_id option set") unless bundle_id

    local_version, local_build = get_local_version_and_build
    build = options[:build] || local_build
    version = options[:version] || local_version

    Dir.chdir("..") do
      sh("flutter", "pub", "get")
      # TODO: implement changing the app name as well, see android section above
      sh("flutter", "pub", "run", "rename", "--target", "ios", "--bundleId", bundle_id)
      sh("flutter", "build", "ipa", "--build-number", build.to_s, "--build-name", version.to_s, "--no-codesign")
    end

    convert_archive_to_unsigned_ipa

    Dir.chdir("..") do
      sh("mv", "build/ios/ipa/wallet-unsigned.zip", "build/ios/ipa/#{bundle_id}-#{version}.ipa")
    end
  end

  # Apple does not let us create an unsigned .ipa, so we have to do it manually
  private_lane :convert_archive_to_unsigned_ipa do
    Dir.chdir("..") do
      sh("mv", "build/ios/archive/Runner.xcarchive/Products/Applications", "build/ios/archive/Runner.xcarchive/Products/Payload")
    end
    
    zip(path: "build/ios/archive/Runner.xcarchive/Products/Payload", output_path: "build/ios/ipa/wallet-unsigned.zip")

    Dir.chdir("..") do
      sh("mv", "build/ios/archive/Runner.xcarchive/Products/Payload", "build/ios/archive/Runner.xcarchive/Products/Applications")
    end
  end
end
